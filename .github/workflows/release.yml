name: Create Release

on:
  workflow_dispatch:  # 手動実行のみ
    inputs:
      version_type:
        description: 'バージョンインクリメントタイプ'
        required: false
        default: 'minor'
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write  # タグとリリースを作成するため
  pull-requests: write  # プルリクエストを作成するため

jobs:
  release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.new_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 全履歴を取得（タグ作成のため）

      - name: Get current version
        id: current_version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //')
          echo "current_version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"

      - name: Increment version
        id: version
        run: |
          CURRENT_VERSION="${{ steps.current_version.outputs.current_version }}"
          VERSION_TYPE="${{ github.event.inputs.version_type || 'patch' }}"
          
          # バージョンを分割
          IFS='.' read -r -a VERSION_PARTS <<< "$CURRENT_VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}
          
          # バージョンをインクリメント
          case "$VERSION_TYPE" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac
          
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"
          
          # pubspec.yamlを更新
          sed -i "s/^version: .*/version: $NEW_VERSION/" pubspec.yaml

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Ensure on main branch
        run: |
          git checkout main
          git pull origin main

      - name: Create release branch
        id: branch
        run: |
          BRANCH_NAME="release/v${{ steps.version.outputs.new_version }}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          git checkout -b "$BRANCH_NAME"
          echo "Created branch: $BRANCH_NAME"

      - name: Commit version bump
        run: |
          git add pubspec.yaml
          git commit -m "Bump version to ${{ steps.version.outputs.new_version }}" || exit 0

      - name: Create tag
        run: |
          git tag -a "v${{ steps.version.outputs.new_version }}" -m "Release v${{ steps.version.outputs.new_version }}"

      - name: Push release branch and tag
        run: |
          git push origin "${{ steps.branch.outputs.branch_name }}"
          git push origin "v${{ steps.version.outputs.new_version }}"

      - name: Create Pull Request
        run: |
          gh pr create \
            --base main \
            --head "${{ steps.branch.outputs.branch_name }}" \
            --title "Release v${{ steps.version.outputs.new_version }}" \
            --body "## バージョン更新: v${{ steps.version.outputs.new_version }}
          
          このPRは自動的に作成されました。
          
          - バージョン: ${{ steps.current_version.outputs.current_version }} → ${{ steps.version.outputs.new_version }}
          - インクリメントタイプ: ${{ github.event.inputs.version_type || 'patch' }}
          
          **注意**: このPRをマージすると、ビルドとデプロイが自動的に実行されます。" \
            || echo "PR creation failed or PR already exists"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.new_version }}
          name: Release v${{ steps.version.outputs.new_version }}
          body: |
            ## Release v${{ steps.version.outputs.new_version }}
            
            Automated release created by GitHub Actions.
          draft: false
          prerelease: false
